<script>
/* =====================
   CONFIGURAÃ‡Ã•ES GERAIS
===================== */
const OFFLINE_LIMIT_HOURS = 8;
const COINS_PER_REAL = 100000;
let BOOSTER_DURATION = 30;
const AD_COOLDOWN = 300;

/* =====================
   ESTADO DO JOGO
===================== */
let player = {
  wallet: 0,
  username: "",
  coins: 0,
  rate: 0.025,
  lastActive: Date.now(),
  lastAdTime: 0,
  upgrades: {
    pickaxe: 0,
    training: 0,
    booster: 0
  }
};

let multiplier = 1;
let boosterActive = false;
let boostRemaining = 0;
let boostInterval = null;

/* =====================
   LOAD
===================== */
window.onload = () => {
  const saved = localStorage.getItem("idlePlayer");
  if (saved) {
    player = JSON.parse(saved);

    player.coins ??= 0;
    player.rate ??= 0.025;
    player.wallet ??= 0;
    player.lastActive ??= Date.now();
    player.lastAdTime ??= 0;
    player.upgrades ??= { pickaxe:0, training:0, booster:0 };

    // Recalcula multiplicador com base no treinamento
    multiplier = 1 + (player.upgrades.training * 0.05);

    applyOfflineMining();
    autoLogin();
  }
};

/* =====================
   SAVE
===================== */
function saveGame() {
  player.lastActive = Date.now();
  localStorage.setItem("idlePlayer", JSON.stringify(player));
}

/* =====================
   LOGIN
===================== */
function login() {
  const name = document.getElementById("username").value.trim();
  if (!name) return alert("Digite um nome");

  player.username = name;
  saveGame();
  enterGame();
}

function autoLogin() {
  if (!player.username) return;
  enterGame();
}

function enterGame() {
  document.getElementById("walletBox").classList.remove("hidden");
  document.getElementById("playerName").innerText = player.username;
  document.getElementById("loginBox").classList.add("hidden");
  document.getElementById("gameBox").classList.remove("hidden");
  startMiningAnimation();
  updateUI();
  updateWallet();
}

/* =====================
   OFFLINE MINING
===================== */
function applyOfflineMining() {
  const now = Date.now();
  let offlineSeconds = Math.floor((now - player.lastActive) / 1000);

  const MAX_OFFLINE = OFFLINE_LIMIT_HOURS * 60 * 60;
  if (offlineSeconds <= 0) return;

  if (offlineSeconds > MAX_OFFLINE) {
    offlineSeconds = MAX_OFFLINE;
  }

  const earned = offlineSeconds * player.rate * multiplier;
  player.coins += earned;
  player.lastActive = now;

  saveGame();

  alert(`â›ï¸ VocÃª minerou ${earned.toFixed(3)} coins offline (${Math.floor(offlineSeconds/60)} min)`);
}

/* =====================
   ONLINE MINING
===================== */
setInterval(() => {
  if (!player.username) return;
  player.coins += player.rate * multiplier;
  saveGame();
  updateUI();
}, 1000);

/* =====================
   BOOSTER
===================== */
function watchAd() {
  const now = Date.now();
  const elapsed = Math.floor((now - player.lastAdTime) / 1000);

  if (elapsed < AD_COOLDOWN) {
    alert(`Aguarde ${AD_COOLDOWN - elapsed}s para novo anÃºncio`);
    return;
  }

  if (boosterActive) return;

  boosterActive = true;
  multiplier *= 2;
  boostRemaining = BOOSTER_DURATION;
  player.lastAdTime = now;

  document.getElementById("character").classList.add("booster");
  document.getElementById("boostTimer").classList.remove("hidden");
  document.getElementById("boostTime").innerText = boostRemaining;

  boostInterval = setInterval(() => {
    boostRemaining--;
    document.getElementById("boostTime").innerText = boostRemaining;

    if (boostRemaining <= 0) endBooster();
  }, 1000);

  saveGame();
}

function endBooster() {
  boosterActive = false;
  multiplier /= 2;
  clearInterval(boostInterval);

  document.getElementById("character").classList.remove("booster");
  document.getElementById("boostTimer").classList.add("hidden");

  saveGame();
}

/* =====================
   LOJA (ECONOMIA NOVA)
===================== */
const shop = {
  pickaxe: {
    baseCost: 50,
    scaling: 1.75,
    effect() {
      player.rate += 0.005;
    }
  },
  training: {
    baseCost: 200,
    scaling: 2,
    effect() {
      multiplier += 0.05;
    }
  },
  booster: {
    baseCost: 250,
    scaling: 2.2,
    effect() {
      BOOSTER_DURATION += 5;
    }
  }
};

function getUpgradeCost(key) {
  const level = player.upgrades[key];
  return shop[key].baseCost * Math.pow(shop[key].scaling, level);
}

function buyUpgrade(key) {
  const cost = getUpgradeCost(key);
  if (player.coins < cost) return alert("Moedas insuficientes");

  player.coins -= cost;
  player.upgrades[key]++;
  shop[key].effect();

  saveGame();
  updateUI();
}

/* =====================
   UI
===================== */
function updateUI() {
  document.getElementById("coins").innerText = player.coins.toFixed(3);
  document.getElementById("rate").innerText = (player.rate * multiplier).toFixed(3);

  document.getElementById("pickaxeInfo").innerText =
    `(Lvl ${player.upgrades.pickaxe} | ${getUpgradeCost("pickaxe").toFixed(1)})`;

  document.getElementById("trainingInfo").innerText =
    `(Lvl ${player.upgrades.training} | ${getUpgradeCost("training").toFixed(1)})`;

  document.getElementById("boosterInfo").innerText =
    `(Lvl ${player.upgrades.booster} | ${getUpgradeCost("booster").toFixed(1)})`;
}

function updateWallet() {
  document.getElementById("walletBalance").innerText = player.wallet.toFixed(3);
}

/* =====================
   AÃ‡Ã•ES
===================== */
function collectCoins() {
  if (player.coins <= 0) return alert("Nada para coletar");
  player.wallet += player.coins;
  player.coins = 0;
  saveGame();
  updateUI();
  updateWallet();
}

function withdraw() {
  const MIN_WITHDRAW = 100000;
  if (player.wallet < MIN_WITHDRAW)
    return alert(`Saque mÃ­nimo: ${MIN_WITHDRAW} coins (R$1)`);

  alert("ðŸš§ Saque real serÃ¡ ativado com backend");
}

function logout() {
  saveGame();
  document.getElementById("gameBox").classList.add("hidden");
  document.getElementById("loginBox").classList.remove("hidden");
  document.getElementById("walletBox").classList.add("hidden");
  player.username = "";
}

function startMiningAnimation() {
  document.getElementById("character").classList.add("mining");
}
</script>
